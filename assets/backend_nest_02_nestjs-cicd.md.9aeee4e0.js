import{_ as s,o as n,c as a,M as l}from"./chunks/framework.de00ba72.js";const b=JSON.parse('{"title":"Nestjs é¡¹ç›® CI/CD","description":"","frontmatter":{},"headers":[],"relativePath":"backend/nest/02_nestjs-cicd.md","filePath":"backend/nest/02_nestjs-cicd.md","lastUpdated":1692610285000}'),p={name:"backend/nest/02_nestjs-cicd.md"},e=l(`<h1 id="nestjs-é¡¹ç›®-ci-cd" tabindex="-1">Nestjs é¡¹ç›® CI/CD <a class="header-anchor" href="#nestjs-é¡¹ç›®-ci-cd" aria-label="Permalink to &quot;Nestjs é¡¹ç›® CI/CD&quot;">â€‹</a></h1><blockquote><p>é‡‡ç”¨Github Actions + Docker + pm2 å®ç°Nestjsé¡¹ç›®åœ¨AWSæœåŠ¡å™¨ä¸Šçš„CI/CD</p></blockquote><h2 id="_1-è¿æ¥äº‘æœåŠ¡å™¨" tabindex="-1">1. è¿æ¥äº‘æœåŠ¡å™¨ <a class="header-anchor" href="#_1-è¿æ¥äº‘æœåŠ¡å™¨" aria-label="Permalink to &quot;1. è¿æ¥äº‘æœåŠ¡å™¨&quot;">â€‹</a></h2><h3 id="_1-1-æ ¹æ®awsæ–‡æ¡£-è¿æ¥æœåŠ¡å™¨" tabindex="-1">1.1 æ ¹æ®AWSæ–‡æ¡£ï¼Œè¿æ¥æœåŠ¡å™¨ <a class="header-anchor" href="#_1-1-æ ¹æ®awsæ–‡æ¡£-è¿æ¥æœåŠ¡å™¨" aria-label="Permalink to &quot;1.1 æ ¹æ®AWSæ–‡æ¡£ï¼Œè¿æ¥æœåŠ¡å™¨&quot;">â€‹</a></h3><ul><li><a href="https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/AccessingInstancesLinux.html" target="_blank" rel="noreferrer">AWSæ–‡æ¡£</a></li></ul><ol><li>ä¸‹è½½æœåŠ¡å™¨ç§é’¥</li><li>chmod 400 xxx.pem</li><li>xxx.pem æ”¾åœ¨ ~/.ssh/ ä¸‹</li><li>.ssh/config æ–‡ä»¶ä¸­æ–°å¢ä¸‹é¢å­—æ®µ</li></ol><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">Host</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ec2</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Hostname</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xxxxx.amazonaws.com</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">user</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ec2-xxx</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">IdentityFile</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.ssh/xxx.pem</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Port</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">22</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="5"><li>æ‰§è¡Œ ssh ec2 è¿æ¥æ­£å¼ç¯å¢ƒæœåŠ¡å™¨</li></ol><h2 id="_2-docker" tabindex="-1">2. Docker <a class="header-anchor" href="#_2-docker" aria-label="Permalink to &quot;2. Docker&quot;">â€‹</a></h2><h3 id="_2-1-å®‰è£…docker" tabindex="-1">2.1 å®‰è£…Docker <a class="header-anchor" href="#_2-1-å®‰è£…docker" aria-label="Permalink to &quot;2.1 å®‰è£…Docker&quot;">â€‹</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yum</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># æ›´æ–°å®ä¾‹ä¸Šå·²å®‰è£…çš„ç¨‹åºåŒ…å’Œç¨‹åºåŒ…ç¼“å­˜</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yum</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># å®‰è£…æœ€æ–°çš„ Docker Community Edition ç¨‹åºåŒ…</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">service</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#å¯åŠ¨ Docker æœåŠ¡</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">usermod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-G</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ec2-user</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># å°† ec2-user æ·»åŠ åˆ° docker ç»„ï¼Œä»¥ä¾¿æ‚¨èƒ½å¤Ÿæ‰§è¡Œ Docker å‘½ä»¤ï¼Œè€Œæ— éœ€ä½¿ç”¨ sudoã€‚</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">newgrp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#æ›´æ–°ç”¨æˆ·ç»„</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">info</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># éªŒè¯ ec2-user æ˜¯å¦èƒ½åœ¨æ²¡æœ‰ sudo çš„æƒ…å†µä¸‹è¿è¡Œ Docker å‘½ä»¤ã€‚</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_2-2-åˆ›å»ºdockerfile" tabindex="-1">2.2 åˆ›å»ºDockerfile <a class="header-anchor" href="#_2-2-åˆ›å»ºdockerfile" aria-label="Permalink to &quot;2.2 åˆ›å»ºDockerfile&quot;">â€‹</a></h3><ul><li>æ ¹æ®è‡ªå·±çš„é¡¹ç›®åˆ›å»ºDockerfile, è¿™é‡Œæ˜¯ä¸ªä¾‹å­ğŸŒ°</li></ul><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node:18.0-alpine3.14</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build-stage</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># åˆ›å»ºå·¥ä½œç›®å½•</span></span>
<span class="line"><span style="color:#FFCB6B;">WORKDIR</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">COPY</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">package.json</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.</span></span>
<span class="line"><span style="color:#FFCB6B;">COPY</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pnpm-lock.yaml</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">RUN</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-g</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">RUN</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># å°† NestJS ä»£ç æ‹·è´åˆ°å·¥ä½œç›®å½•</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">COPY</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">RUN</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># production stage</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">FROM</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node:18.0-alpine3.14</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">production-stage</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">COPY</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--from=build-stage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/app/dist</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/app</span></span>
<span class="line"><span style="color:#FFCB6B;">COPY</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--from=build-stage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/app/package.json</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/app/package.json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">WORKDIR</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">RUN</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-g</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">RUN</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">RUN</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pm2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-g</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">EXPOSE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># åœ¨å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œ NestJS é¡¹ç›®</span></span>
<span class="line"><span style="color:#FFCB6B;">CMD</span><span style="color:#A6ACCD;"> [</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pm2-runtime</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/app/main.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="_2-3-ç™»å½•docker-hub" tabindex="-1">2.3 ç™»å½•Docker-hub <a class="header-anchor" href="#_2-3-ç™»å½•docker-hub" aria-label="Permalink to &quot;2.3 ç™»å½•Docker-hub&quot;">â€‹</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">login</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># è¾“å…¥ç”¨æˆ·åå’Œå¯†ç </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># ç™»å½•æˆåŠŸ</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><a href="https://hub.docker.com/repositories/codehzy" target="_blank" rel="noreferrer">åˆ›å»ºå­˜å‚¨é•œåƒåœ°æ–¹</a></p><p><img src="https://imgsbed-1301560453.cos.ap-shanghai.myqcloud.com//blog202308010045522.png" alt=""></p><h2 id="_3-github-actions" tabindex="-1">3. Github Actions <a class="header-anchor" href="#_3-github-actions" aria-label="Permalink to &quot;3. Github Actions&quot;">â€‹</a></h2><h3 id="_3-1-åˆ›å»ºgithub-actions" tabindex="-1">3.1 åˆ›å»ºGithub Actions <a class="header-anchor" href="#_3-1-åˆ›å»ºgithub-actions" aria-label="Permalink to &quot;3.1 åˆ›å»ºGithub Actions&quot;">â€‹</a></h3><ul><li><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º .github/workflows/deploy.yml æ–‡ä»¶</p></li><li><p>DOCKER_USERNAME: Docker Hub ç”¨æˆ·å</p></li><li><p>DOCKER_PASSWORD: Docker Hub å¯†ç </p></li><li><p>EC2_HOST: äº‘æœåŠ¡å™¨å…¬ç½‘IP</p></li><li><p>EC2_USERNAME: äº‘æœåŠ¡å™¨ç”¨æˆ·å</p></li><li><p>EC2_PRIVATE_KEY: äº‘æœåŠ¡å™¨ç§é’¥(<strong>éœ€è¦æ‰‹åŠ¨åˆ›å»º- ä¸€å®šè¦è·Ÿç€ä¸‹æ–¹åš,è¿™æ˜¯ä¸ªå‘ç‚¹</strong>)</p></li></ul><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Simple way just:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">ssh-keygen</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-t</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ed25519</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-a</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-C</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">your@email.com</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># enter name of ssh-key for example: thorn</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">thorn.pub</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.ssh/authorized_keys</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">finally</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">copy</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ssh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">key:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">thorn</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Copy value between \` -----BEGIN OPENSSH PRIVATE KEY----- some value of ssh-key -----END OPENSSH PRIVATE KEY-----</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>SSH_PORT: äº‘æœåŠ¡å™¨SSHç«¯å£</li></ul><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">name:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">CI/CD</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Nest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">on:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">push:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">branches:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">jobs</span><span style="color:#A6ACCD;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">build-test-deploy:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">runs-on:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">self-hosted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">steps:</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Checkout</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">code</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">uses:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">actions/checkout@v2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Login</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Hub</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">uses:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker/login-action@v1</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">with:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">username:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">{ secrets.DOCKER_USERNAME </span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">password:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">{ secrets.DOCKER_PASSWORD </span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Build</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">and</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Push</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Image</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">uses:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker/build-push-action@v2</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">with:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">context:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">push:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">tags:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">codehzy/hello-world:latest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Deploy</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Ec2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">instance</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">uses:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">appleboy/ssh-action@v0.1.4</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">with:</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">host:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">{ secrets.EC2_HOST </span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">username:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">{ secrets.EC2_USERNAME </span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">key:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">{ secrets.EC2_PRIVATE_KEY </span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">port:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\${</span><span style="color:#A6ACCD;">{ secrets.SSH_PORT </span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#FFCB6B;">script:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">script:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">whoami</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stop</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">hello-world</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">hello-world</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">||</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pull</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">codehzy/hello-world:latest</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#C3E88D;">:3000</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">hello-world:latest</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="_3-2-ç‚¹å‡»ä»“åº“" tabindex="-1">3.2 ç‚¹å‡»ä»“åº“ <a class="header-anchor" href="#_3-2-ç‚¹å‡»ä»“åº“" aria-label="Permalink to &quot;3.2 ç‚¹å‡»ä»“åº“&quot;">â€‹</a></h3><blockquote><p>setting -&gt; secrets -&gt; new repository secret æ·»åŠ å¯¹åº”ç§˜é’¥ æ³¨æ„: ç§˜é’¥åç§°è¦è·Ÿä¸Šé¢çš„ä¸€è‡´</p><p>setting -&gt; Code and automation -&gt; Actions -&gt; Runners -&gt; Add runner -&gt; Linux -&gt; é€‰æ‹©è‡ªå·±çš„ç³»ç»Ÿ -&gt; ä¸‹è½½å¯¹åº”çš„runner -&gt; è§£å‹ -&gt; è¿è¡Œ æ³¨æ„: è¿™ä¸€æ­¥è·Ÿç€githubçš„æ­¥éª¤èµ°,åå­—è¦èµ·çš„ä¸github actionsä¸­çš„ä¸€è‡´, è¿™æ ·å½“ä½ æäº¤ä»£ç çš„æ—¶å€™(mainåˆ†æ”¯), github actionså°±ä¼šè‡ªåŠ¨è¿è¡Œäº†, å¹¶å°†ä»»åŠ¡æ‰˜ç®¡ç»™runner, ä»è€Œå®ŒæˆæœåŠ¡å™¨ä¸Šçš„é…ç½®</p></blockquote><h2 id="x-æ³¨æ„ç‚¹" tabindex="-1">X: æ³¨æ„ç‚¹ <a class="header-anchor" href="#x-æ³¨æ„ç‚¹" aria-label="Permalink to &quot;X: æ³¨æ„ç‚¹&quot;">â€‹</a></h2><h3 id="_1-how-to-fix-docker-got-permission-denied-while-trying-to-connect-to-the-docker-daemon-socket" tabindex="-1">1. How to fix docker: Got permission denied while trying to connect to the Docker daemon socket <a class="header-anchor" href="#_1-how-to-fix-docker-got-permission-denied-while-trying-to-connect-to-the-docker-daemon-socket" aria-label="Permalink to &quot;1. How to fix docker: Got permission denied while trying to connect to the Docker daemon socket&quot;">â€‹</a></h3><p><a href="https://www.digitalocean.com/community/questions/how-to-fix-docker-got-permission-denied-while-trying-to-connect-to-the-docker-daemon-socket" target="_blank" rel="noreferrer">è§£å†³åŠæ³•</a></p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">chmod</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">666</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/run/docker.sock</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_2-ssh-handshake-failed-ssh-unable-to-authenticate-attempted-methods-none-publickey-no-supported-methods-remain" tabindex="-1">2. ssh: handshake failed: ssh: unable to authenticate, attempted methods [none publickey], no supported methods remain <a class="header-anchor" href="#_2-ssh-handshake-failed-ssh-unable-to-authenticate-attempted-methods-none-publickey-no-supported-methods-remain" aria-label="Permalink to &quot;2. ssh: handshake failed: ssh: unable to authenticate, attempted methods [none publickey], no supported methods remain&quot;">â€‹</a></h3><p><img src="https://imgsbed-1301560453.cos.ap-shanghai.myqcloud.com//blog202308010051216.png" alt=""></p><p>å‚è€ƒ<a href="https://github.com/appleboy/ssh-action/issues/80" target="_blank" rel="noreferrer">è§£å†³åŠæ³•</a></p><h3 id="æŒç»­éƒ¨ç½²-dockerä¼šæŠ¥é”™" tabindex="-1">æŒç»­éƒ¨ç½²,dockerä¼šæŠ¥é”™ <a class="header-anchor" href="#æŒç»­éƒ¨ç½²-dockerä¼šæŠ¥é”™" aria-label="Permalink to &quot;æŒç»­éƒ¨ç½²,dockerä¼šæŠ¥é”™&quot;">â€‹</a></h3><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rmi</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> images -qa</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#å¼ºåˆ¶åˆ é™¤æ‰€æœ‰docker-images</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rmi</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">id</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#å¼ºåˆ¶åˆ é™¤æŒ‡å®šçš„docker-images</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ps</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-a</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">container</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ls</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-a</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#æŸ¥çœ‹æ‰€æœ‰çš„å®¹å™¨</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div>`,35),o=[e];function r(c,t,C,i,y,A){return n(),a("div",null,o)}const u=s(p,[["render",r]]);export{b as __pageData,u as default};
